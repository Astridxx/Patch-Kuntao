From 3b347962115b0e94c1d72c194270345cff6f8e70 Mon Sep 17 00:00:00 2001
From: cjh1249131356 <cjh1249131356@gmail.com>
Date: Mon, 11 Apr 2022 13:45:00 +0800
Subject: [PATCH] SettingsProvider: Handle WRITE_DEVICE_CONFIG permission
 denial for gms

Signed-off-by: cjh1249131356 <cjh1249131356@gmail.com>
---
 .../providers/settings/SettingsProvider.java  | 20 +++++++++++++++----
 1 file changed, 16 insertions(+), 4 deletions(-)

diff --git a/packages/SettingsProvider/src/com/android/providers/settings/SettingsProvider.java b/packages/SettingsProvider/src/com/android/providers/settings/SettingsProvider.java
index 84a559391343..8334b44d45e5 100644
--- a/packages/SettingsProvider/src/com/android/providers/settings/SettingsProvider.java
+++ b/packages/SettingsProvider/src/com/android/providers/settings/SettingsProvider.java
@@ -1159,8 +1159,8 @@ private boolean insertConfigSetting(String name, String value, boolean makeDefau
             Slog.v(LOG_TAG, "setAllConfigSettings for prefix: " + prefix);
         }
 
-        enforceWritePermission(Manifest.permission.WRITE_DEVICE_CONFIG);
         final String callingPackage = resolveCallingPackage();
+        enforceWriteDeviceConfigPermission(callingPackage);
 
         synchronized (mLock) {
             if (getSyncDisabledModeConfigLocked() != SYNC_DISABLED_MODE_NONE) {
@@ -1178,7 +1178,8 @@ private void setSyncDisabledModeConfig(@SyncDisabledMode int syncDisabledMode) {
             Slog.v(LOG_TAG, "setSyncDisabledModeConfig(" + syncDisabledMode + ")");
         }
 
-        enforceWritePermission(Manifest.permission.WRITE_DEVICE_CONFIG);
+        final String callingPackage = resolveCallingPackage();
+        enforceWriteDeviceConfigPermission(callingPackage);
 
         synchronized (mLock) {
             setSyncDisabledModeConfigLocked(syncDisabledMode);
@@ -1190,7 +1191,8 @@ private int getSyncDisabledModeConfig() {
             Slog.v(LOG_TAG, "getSyncDisabledModeConfig");
         }
 
-        enforceWritePermission(Manifest.permission.WRITE_DEVICE_CONFIG);
+        final String callingPackage = resolveCallingPackage();
+        enforceWriteDeviceConfigPermission(callingPackage);
 
         synchronized (mLock) {
             return getSyncDisabledModeConfigLocked();
@@ -1275,8 +1277,8 @@ private void resetConfigSetting(int mode, String prefix) {
 
     private boolean mutateConfigSetting(String name, String value, String prefix,
             boolean makeDefault, int operation, int mode) {
-        enforceWritePermission(Manifest.permission.WRITE_DEVICE_CONFIG);
         final String callingPackage = resolveCallingPackage();
+        enforceWriteDeviceConfigPermission(callingPackage);
 
         // Perform the mutation.
         synchronized (mLock) {
@@ -2270,6 +2272,16 @@ private void enforceWritePermission(String permission) {
         }
     }
 
+    private void enforceWriteDeviceConfigPermission(String packageName) {
+        if (packageName.equals("com.google.android.gms")) return;
+        if (getContext().checkCallingOrSelfPermission(Manifest.permission.WRITE_DEVICE_CONFIG)
+                != PackageManager.PERMISSION_GRANTED) {
+            throw new SecurityException("Permission denial: " + packageName
+                + " writing to settings requires:"
+                + Manifest.permission.WRITE_DEVICE_CONFIG);
+        }
+    }
+
     private static void warnOrThrowForUndesiredSecureSettingsMutationForTargetSdk(
             int targetSdkVersion, String name) {
         // If the app targets Lollipop MR1 or older SDK we warn, otherwise crash.
