From 0e26d40db5a1f1baeeb6849f971688d34fea1967 Mon Sep 17 00:00:00 2001
From: Murat Kozan <muratkozan350@gmail.com>
Date: Sat, 17 Feb 2024 19:54:54 +0300
Subject: [PATCH] BluetoothControllerImpl: Optimize connected battery level
 scanning

---
 .../statusbar/policy/BluetoothControllerImpl.java   | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/policy/BluetoothControllerImpl.java b/packages/SystemUI/src/com/android/systemui/statusbar/policy/BluetoothControllerImpl.java
index c7084ade5bf5..489c0a560a74 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/policy/BluetoothControllerImpl.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/policy/BluetoothControllerImpl.java
@@ -18,6 +18,7 @@
 
 import android.annotation.Nullable;
 import android.bluetooth.BluetoothAdapter;
+import android.bluetooth.BluetoothDevice;
 import android.bluetooth.BluetoothProfile;
 import android.content.Context;
 import android.os.Handler;
@@ -349,11 +350,17 @@ private void updateAudioProfile() {
     @Override
     public int getBatteryLevel() {
         synchronized (mConnectedDevices) {
-            if (!mConnectedDevices.isEmpty()) {
-                return mConnectedDevices.get(0).getBatteryLevel();
+            if (mConnectedDevices.isEmpty()) {
+                return BluetoothDevice.BATTERY_LEVEL_UNKNOWN;
             }
+            for (CachedBluetoothDevice device : mConnectedDevices) {
+                int level = device.getBatteryLevel();
+                if (level != BluetoothDevice.BATTERY_LEVEL_UNKNOWN) {
+                    return level;
+                }
+            }
+            return BluetoothDevice.BATTERY_LEVEL_UNKNOWN;
         }
-        return -1;
     }
 
     private void updateBattery() {
